# MistWANPerformance - Redis Configuration
#
# Optimized for 31-day historical data retention with persistence.
# This configuration prioritizes data durability over raw performance.

# -----------------------------------------------------------------------------
# NETWORK
# -----------------------------------------------------------------------------

# Listen on all interfaces (Docker networking)
bind 0.0.0.0

# Default port
port 6379

# Connection timeout (0 = no timeout)
timeout 0

# TCP keepalive
tcp-keepalive 300

# -----------------------------------------------------------------------------
# PERSISTENCE - AOF (Append Only File)
# -----------------------------------------------------------------------------
# AOF provides better durability - logs every write operation.
# Data can be recovered even after a crash.

# Enable AOF persistence
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# Sync policy:
# - always: fsync after every write (safest, slowest)
# - everysec: fsync once per second (good balance) [RECOMMENDED]
# - no: let OS handle it (fastest, least safe)
appendfsync everysec

# Don't fsync during rewrite (improves performance)
no-appendfsync-on-rewrite no

# Auto-rewrite AOF when it grows too large
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# -----------------------------------------------------------------------------
# PERSISTENCE - RDB (Snapshots)
# -----------------------------------------------------------------------------
# RDB provides point-in-time snapshots as backup.
# Keep both AOF and RDB for maximum safety.

# Save snapshots:
# - After 900 seconds (15 min) if at least 1 key changed
# - After 300 seconds (5 min) if at least 100 keys changed
# - After 60 seconds if at least 10000 keys changed
save 900 1
save 300 100
save 60 10000

# RDB filename
dbfilename dump.rdb

# Working directory for persistence files
dir /data

# Compress RDB files
rdbcompression yes

# Checksum RDB files
rdbchecksum yes

# Stop accepting writes if RDB save fails (safety feature)
stop-writes-on-bgsave-error yes

# -----------------------------------------------------------------------------
# MEMORY MANAGEMENT
# -----------------------------------------------------------------------------

# Maximum memory limit (adjust based on your data size)
# 31 days * 24 hours * 500 sites * ~1KB per record = ~372MB
# Add overhead for keys, indexes, etc. = ~1GB recommended minimum
maxmemory 1gb

# Eviction policy when max memory is reached
# volatile-lru: Evict keys with TTL set, least recently used first
# This preserves non-expiring reference data while evicting old historical data
maxmemory-policy volatile-lru

# -----------------------------------------------------------------------------
# LOGGING
# -----------------------------------------------------------------------------

# Log level: debug, verbose, notice, warning
loglevel notice

# Log to stdout (for Docker)
logfile ""

# -----------------------------------------------------------------------------
# SECURITY
# -----------------------------------------------------------------------------

# Disable dangerous commands in production
# Uncomment if needed:
# rename-command FLUSHALL ""
# rename-command FLUSHDB ""
# rename-command DEBUG ""

# -----------------------------------------------------------------------------
# PERFORMANCE TUNING
# -----------------------------------------------------------------------------

# Number of databases (we only use db 0)
databases 1

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Lazy freeing (async deletion)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
